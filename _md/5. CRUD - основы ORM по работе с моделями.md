## Учимся работать с таблицей
GRUD
*  Create - создание 
* Read - чтение
* Update - изменение
* Delete - удаление


![[Pasted image 20220715161324.png]]

`~/djsite/coolsite$ python manage.py shell`

```python
# python manage.py shell 
from women.models import Women
# создаём экземпляр класса с двумя именными параметрами
Women(title='Анджелина Джоли', content='Биография Анджелины Джоли')
# нижнее подчёркивание сохраняет в себе последнее дейтсвие
w1 = _
# метод .save() используется для сохранения в таблицу
w1.save()
# атрибут pk совпадающий с id
w1.pk

#Просмотр sql запросов
from django.db import connection
connection.queries
"""
[{'sql': 'INSERT INTO "women_women" ("title", "content", "photo", "time_create", "time_update", "is_published") SELECT \'Анджелина Джоли\', \'Биография Анджелины Джоли\', \'\', \'2022-07-15 13:42:37.384106\', \'2022-07-15 13:42:37.384203\', 1 RETURNING "women_women"."id"', 'time': '0.004'}]
"""

# Ещё один запрос для примера 
w2 = Women(title='Энн Хэтэуэй', content='Биография Энн Хэтэуэй')
w2.save()

# Т.к. процесс ленивый то можно объект класса наполнять не сразу 
w3 = Women()
w3.title = 'Джулия Робертс'
w3.content = 'Биография Джулии Робертс'
w3.save()

```

### Менеджер записей objects 
Каждый класс модели содержит специальный статический объект objects, который наследуется от базового класса Model и представляет собой ссылку на специальный класс Manager.
```python 
Women.objects
"""
<django.db.models.manager.Manager object at 0x000001AA3D7655A0>
"""
```
Объект objects, так же называется **менеджером записей**,  имеет несколько полезных методов.
1. Метод добавления create()
```python
# Не забываем про from women.models import Women
Women.objects.create(title='Ума Турман', content='Биография Ума Турман')
# если теперь обратиться к свойсву w4.pk то увидим что запись была автоматически добавлена в БД
```

### Выборка записей из таблицы
Для чтения данных из таблицы women можно воспользоваться менеджером записей - объектро objects и выполнить метод all()
```python
Women.objects.all()
# На выходе список объекта QuerySet
"""
<QuerySet [<Women: Women object (1)>, <Women: Women object (2)>, <Women: Women object (3)>, <Women: Women object (4)>, <Women: Women object (5)>, <Women: Women object (6)>]>
"""
```
Чтобы выводились заголовки вместо записей с идентификаторами необходимо переопределить магический метод `__str__`
```python
# djsite/coolsite/women/models.py
class Women(models.Model):
	def __str__(self):
		return self.title
# ...
```
После этого перезаходим в консоль:
```python
python manage.py shell 
from women.models import Women
Women.objects.all()
# Теперь в консоли отображаются заголовки записей, а не их id
"""
<QuerySet [<Women: Анджелина Джоли>, <Women: Энн Хэтэуэй>, <Women: Джулия Робертс>, <Women: Ума Турман>, <Women: Кира Найтли>, <Women: Кира Найтли>]>
"""
```

Для работы с отдельной записью есть следующие команды
```python
w = Women.objects.all()
w[0]
w[0].title
w[0].content
len(w)
for wi in w:
	print(wi.title)
```

#### .filter()
Чтобы возвращать только нужные значения используют метод `filter()`
```python
Women.objects.filter(title='Энн Хэтэуэй')
# возвращает список из одного элемента
"<QuerySet [<Women: Энн Хэтэуэй>]>"
```
Посмотрим sql запрос
```python
from django.db import connection
connection.queries
"""
'SELECT "women_women"."id", "women_women"."title", "women_women"."content", "women_women"."photo", "women_women"."time_create", "women_women"."time_update", "women_women"."is_published" FROM "women_women" WHERE "women_women"."title" = \'Энн Хэтэуэй\' LIMIT 21'
"""
```
Метод filter использует оператор WHERE для формирования выборки. Если условию не будет удовлетворять ни одна запись, то получим пустой списко

##### Выборка по id
pk  - это именованный параметр и ему нужно явно присваивать определенное значение. Поэтому в Django базовым атрибутам, определенным в модели, автоматически добавляются их аналоги, например, такие:
* -  `<имя атрибута>__gte` – сравнение больше или равно (>=)
-   `<имя атрибута>__lte` – сравнение меньше или равно (<=).

```python
Women.objects.filter(pk__gte=2)
"""
<QuerySet [<Women: Энн Хэтэуэй>, <Women: Джулия Робертс>, <Women: Ума Турман>, <Women: 
Кира Найтли>, <Women: Кира Найтли>]>
"""
```

##### exclude()
Метод exclude() выбирает записи не удовлетворяющие указанному условию
```python
Women.objects.exclude(pk=2)
"""
<QuerySet [<Women: Анджелина Джоли>, <Women: Джулия Робертс>, <Women: Ума Турман>, <Women: Кира Найтли>, <Women: Кира Найтли>]>
"""
```

##### выборка конкретной записи
Для выборки конкретной записи не стоит использовать метод .filter() например 
```pyhton
Women.objects.filter(pk=2)
```
т.к. такой метод может вернуть несколько записей или пустой список. Что бы получить только одну запись надо использовать метод .get()
```python
Women.objects.get(pk=20)
```

##### Сортировка записей
Для сортировки используется метод `.order_by()` например
```python
Women.objects.filter(pk__lte=4).order_by('title')
Women.objects.order_by('title')
```
Если нужно изменить список сортировки то нужно поставить занк `-`
```python
Women.objects.order_by('-time_update')
```

##### Изменение записей
1. Читаем запись из БД
```python
wu = Women.objects.get(pk=2)
```
2.  Присваиваем атрибутам объекта Women другие значения
```python
wu.title = 'Марго Робби'
wu.content = 'Биография Марго Робби'
```
3.  Сохраняем новые данные
```python
wu.save()
```
Запрос в sql выглядит следующим образом
```python
connection.queries
"""
'UPDATE "women_women" SET "title" = \'Марго Робби\', "content" = \'Биография Марго Робби\', "photo" = \'\', "time_create" = \'2021-01-03 09:27:56.511898\', "time_update" = \'2021-01-03 11:57:06.800768\', "is_published" = 1 WHERE "women_women"."id" = 2'
"""

```

##### Удаление записей
1. Выбираем записи которые надо удалить
```python
wd = Women.objects.filter(pk__gte=4)
```
2. Выполняем для них метод delete()
```python
wd.delete()
```