Задача: создадим таблицу **category** и связать её с таблицей постов
![[Pasted image 20220802102608.png]]
**Нормализация данных** называется разделение данных на несколько таблиц и установление между ними связей.

Фреймворк Djnago имеет три специальных класса для организации связей:

-   ForeignKey – для связей Many to One (поля отношений);
-   ManyToManyField – для связей Many to Many (многие ко многим);
-   OneToOneField – для связей One to One (один к одному).
В нашем примере будет использоваться класс `ForeignKey`
Он принимает два аргумента:
-   ссылка или строка класса модели, с которой происходит связывание (в нашем случае это класс Category – модели для категорий);
-   опция on_delete, накладывающая ограничения при удалении внешней записи (в нашем примере – это удаление из таблицы Category).
`cat = models.ForeignKey('Category', on_delete=models.PROTECT)`
опция on_delete может принимать следующие значения:
-   models.CASCADE – при удалении записи из первичной модели (у нас это таблица Category) происходит удаление всех записей из вторичной модели (Women), связанных с удаляемой категорией;
-   models.PROTECT – запрещает удаление записи из первичной модели, если она используется во вторичной (выдает исключение);
-   models.SET_NULL – при удалении записи первичной модели устанавливает значение foreign key в NULL у соответствующих записей вторичной модели;
-   models.SET_DEFAULT – то же самое, что и SET_NULL, только вместо значения NULL устанавливает значение по умолчанию, которое должно быть определено через класс ForeignKey;
-   models.SET() – то же самое, только устанавливает пользовательское значение;
-   models.DO_NOTHING – удаление записи в первичной модели не вызывает никаких действий у вторичных моделей.
## Cоздадание таблицы **category** и связывание её с таблицей постов
1. Добавление новой модели и редактирование старой
`djsite/coolsite/women/models.py`
``` python
#from django.db import models
#from django.urls import reverse
#
#class Women(models.Model):
#    title = models.CharField(max_length=255)
#    content = models.TextField(blank=True)
#    photo = models.ImageField(upload_to="photos/%Y/%m/%d")
#    time_create = models.DateTimeField(auto_now_add=True)
#    time_update = models.DateTimeField(auto_now=True)
#    is_published = models.BooleanField(default=True)
    """Параметр null используется временно, чтобы не было ошибки при модифицировании модели, указываем что ячейка может быть пустой"""
    cat = models.ForeignKey('Category', on_delete=models.PROTECT, null=True)
    
#    def __str__(self):
#        return self.title
#
#    def get_absolute_url(self):
#        return reverse('post', kwargs={'post_id': self.pk})

class Category(models.Model):
    name = models.CharField(max_length=100, db_index=True)

    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('category', kwargs={'cat_id': self.pk})

```
`db_index=True` - указывает СУБД индексировать данное поле, чтобы поиск по нему происходил быстрее. В результате, в таблице category будет два индексируемых поля: id и name
При прописывания дополнительного поля `cat_id` в вторичной модели Women не обязательно указывать `_id`, Django добавит его автоматически
`on_delete=models.PROTECT` - указывает на то, что запрещено удалять категории, используемых во вторичной модели
2. Модели у нас определены. Теперь надо создать соответсвующие таблицы в БД. 1ую таблицу модифицировать, добавив одно поле, вторую таблицу создать целиком. Для этого формируем новую миграцию командой
   `python manage.py makemigrations`
   После этой команды сформировался второй файл миграции в папке `djsite/coolsite/women/migrations`
3.  Таблицы сформированы, добавим категории в новую таблицу.
   - `python manage.py shell` 
   - `from women.models import *` - импортируем наши модели в консоль фреймворка
   - Создаем две записи в таблице category
 ```shell
Category.objects.create(name='Актрисы')
Category.objects.create(name='Певицы')
```
   -  У всех записей таблицы women установим поле cat_id равным 1
```shell
w_list = Women.objects.all()
w_list.update(cat_id=1)
```

## Отображение категорий в шаблоне
`djsite/coolsite/women/templates/women/base.html`
```HTML
<!-- Sidebar слева 
	<td valign="top" class="left-chapters">
	<ul id="leftchapters">
 -->
{% if cat_selected == 0 %}
		<li class="selected">Все категории</li>	
{% else %}
		<li><a href="{% url 'home' %}">Все категории</a></li>
{% endif %}

{% for c in cats %}
	{% if c.pk == cat_selected %}
		<li class="selected">{{c.name}}</li>
	{% else %}
		<li><a href="{{ c.get_absolute_url }}">{{c.name}}</a></li>
	{% endif %}
{% endfor %}
<!---		
		<li class="share">
		<p>Наш канал</p>
		<a class="share-yt" href="https://www.youtube.com/channel/UClJzWfGWuGJL2t-3dYKcHTA/playlists" target="_blank" rel="nofollow"></a>
		</li>
	</ul>
</td>
<!-- Конец Sidebar'а -->
```

Ссылка формируется в модели при помощи функции
```python
    def get_absolute_url(self):
        return reverse('category', kwargs={'cat_id': self.p
```
URL берётся по имени маршрута `category`. Который определяется в файле `women/urls.py`
```Python
path('category/<int:cat_id>/', show_category, name='category'),
```
Функция в `women/views.py`
```python
def show_category(request, cat_id):
    posts = Women.objects.filter(cat_id=cat_id)
    cats = Category.objects.all()

	if len(posts) == 0:
        raise Http404()
        
    context = {
        'posts': posts,
        'cats': cats,
        'menu': menu,
        'title': 'Главная страница',
        'cat_selected': cat_id,
    }
 
    return render(request, 'women/index.html', context=context)
```
Так же необходимо поменять функцию index добавив cats
```python
def index(request):
    posts = Women.objects.all()
    cats = Category.objects.all()
 
    context = {
        'posts': posts,
        'cats': cats,
        'menu': menu,
        'title': 'Главная страница',
        'cat_selected': 0,
    }
 
    return render(request, 'women/index.html', context=context)
```

`djsite/coolsite/women/templates/women/index.html`
Добавим отображение названия категории и даты создания
```HTML
{% extends 'women/base.html' %} 

{% block content %}
<ul class="list-articles">
	{% for p in posts %}
			<li><div class="article-panel">
				<p class="first">Категория: {{p.cat}}</p>
				<p class="last">Дата: {{p.time_update|date:"d-m-Y H:i:s"}}</p>
			</div>
<!--			<li><h2>{{p.title}}</h2>
	{% autoescape on %}
	{{p.content|linebreaks|truncatewords:50}}
	{% endautoescape %}
			<div class="clear"></div>
			<p class="link-read-post"><a href="{{ p.get_absolute_url }}">Читать пост</a></p>
			</li>
	{% endfor %}
</ul>
{% endblock %}

```
